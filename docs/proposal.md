# 基于KubeEdge构建边云协同的机器人遥操作应用

本项目旨在描述基于[KubeEdge]的远程操作解决方案。作为控制机器人的远程控制技术，此应用为移动机器人提供了通用且易于使用的解决方案，通过该方案机器人操作员可以轻松地在线远程控制机器人。

本提案将解释技术解决方案，包括[动机](#动机)、应用场景、技术架构、设计细节和未来工作等。

## 动机

### 场景

机器人遥操作是指通过公共网络远程控制和监视可移动机器人的状态，实现**任务分配**、**导航**和**云边协作**等功能。遥操作有许多应用场景，例如：

- **制造业**：远程操作可用于处理工厂内的`物料处理`、`检查`和`维护`等任务，提高生产效率和安全性。

- **医疗保健**：远程操作可用于提供`远程诊断`、`治疗`和`护理`服务，缓解医疗资源短缺和地理失衡的问题。

- **智慧城市**：远程操作可用于实现`城市管理`、`环境监测`和`公共服务`等功能，提高城市智能化水平。

### 挑战

机器人遥操作也面临一些挑战和问题，例如：

- **网络延迟**：由于网络传输的延迟和抖动，远程操作的实时性和稳定性可能受到影响，导致控制失败或误操作。

- **数据安全**：网络传输过程中数据泄露或篡改的风险可能威胁到远程操作的可靠性和安全性，导致数据丢失或恶意使用。

- **用户体验**：网络传输过程中的数据压缩或数据包丢失可能影响远程操作的质量和效果，导致图像模糊或卡顿。

为了解决这些挑战和问题，我们建议使用WebRTC服务网关作为远程操作的解决方案。WebRTC是一种开源技术，支持浏览器之间的实时音视频通信。

### 目标

- 利用高可用的商用云服务（如RTC、RTSP、OBS、VPN等）提供超过98%的可靠性率，确保在复杂和动态的环境中进行稳定和低延迟的远程操作。

- 利用[KubeEdge]和容器技术来屏蔽机器人设备异构性问题，并满足解决方案复制的可扩展性要求。

- 通过RTC技术支持双向音频交互，增强远程操作的对话能力。

- 使用[KubeEdge]的消息通道从云端动态加载机器人的技能。

- 将音视频解码等资源密集型任务卸载到云端，减轻机器人本身的负担。

- 使用H.264标准进行视频编解码，并采用流媒体传输，以解决由大量视频数据引起的传输缓慢的挑战。

### 应用场景

- 作为云服务提供商
  - 提供开箱即用的遥操作解决方案，助力机器人解决方案提供商快速完成机器人的远程控制
  - 牵引云厂商其他业务在机器人场景落地，赋能机器人实现算力卸载，降低运营成本

- 解决方案提供商
  - 通过云服务平台一键部署并启停遥操作服务
  - 通过云服务平台一键更新机器人订阅技能
  - 兼容多摄像头的视觉方案，以及云原生架构满足各种异构机器人

- 机器人操作者
  - 通过遥操作服务随时随地控制机器人运动，包括移动、执行机器人订阅的技能等
  - 通过遥操作服务查看机器人状态（电量、信号）和地图信息
  - 通过遥操作服务调整移动速度
  - 通过遥操作服务查看多视角音画，下发语音广播（须具备广播设备）
  - 通过遥操作服务开关视角音画呈现


## 系统架构

基于KubeEdge的边缘云协同远程操作系统的架构包括“边缘（机器人）节点”，“云节点”和边缘云协同控制器。边缘节点负责收集、处理和存储传感器数据，并提供远程远程操作服务。云节点负责存储和分析数据，并提供远程操作控制台。边缘云协同控制器负责管理和协调边缘和云之间的通信、计算和存储资源。

该系统架构包括以下组件：

- **客户端（Teleop-Client）**：客户端可以是浏览器、移动设备或其他支持WebRTC协议的终端，本方案中基于[Astro]("https://www.huaweicloud.com/product/astro.html)开发，通过WebSocket协议与信令服务器进行信令交换，通过UDP协议与WebRTC服务网关进行音视频流传输。
- **信令服务器（Signaling-Server）**：信令服务器负责处理客户端之间的会话建立、媒体协商、控制指令等信令信息，它使用SDP（Session Description Protocol）和ICE（Interactive Connectivity Establishment）协议来描述和建立音视频连接。
- **服务网关（Teleop-Server）**：服务网关负责业务鉴权、机器人列表、会话管理、组件创建等服务。
- **远端机器人（Teleop-Robot）**：远端机器人是一种特殊的客户端，它具备摄像头、麦克风和执行移动控制指令的能力，通过UDP与服务网关进行音视频流传输，以及接收和执行控制指令。
- **STUN/TURN服务器（Turn-Server）**：STUN/TURN服务器负责帮助客户端和WebRTC服务网关实现NAT穿越，即在不同网络环境下获取公网IP地址并建立连接。STUN（Session Traversal Utilities for NAT）服务器用于获取公网IP地址，TURN（Traversal Using Relays around NAT）服务器用于在无法直连的情况下中转数据。

![architectur](images/architecture.jpg)

## 设计细节

### 系统要求

该方案使用与具备移动能力的机器人，应该具备如下要求：

- [KubeEdge] v1.10+ along with **[EdgeMesh]** running
- 本体至少一个可以被获取数据的摄像头
- 本体 &gt; 1U2G 计算单元 
- 云端 &gt; 4U8G/GPU 计算单元 (GPU 尤佳)

### 运行视图

![run-view](images/run-view.png)

### 性能评估

在本研究中，我们进行了一些实验，每组实验都包括局域网和公共网络模式下的实时视频流传输。在实验中，我们测量了服务器和机器人本体的资源开销，以及端到端时延。

具体实验数据如下：

#### 资源开销对比

在第一组实验中，我们将以[AgileX机器人](https://www.agilex.ai/product/3?lang=zh-cn)为例，测试不同网络条件下的资源开销。我们使用了2种不同的网络条件，分别是局域网、广域网(5 G)。实验结果如下：

|  网络条件  | 	SFU模式下机器人本体资源开销（CPU占用率） | 	P2P模式下机器人本体资源开销（CPU占用率） |
|:------:|:------------------------:|:------------------------:|
|  局域网   |          	4.5%           |         	 16.3%          |
|  广域网   |           5.2%           |          17.8%           |


#### 时延对比
在第二组实验中，我们将以单一机器人为例，测试不同网络条件下的端到端时延。我们同样使用了2种不同的网络条件，分别是局域网、广域网(5 G)。实验结果如下：

| 网络条件 | 	SFU模式下端到端时延（ms） | P2P模式下端到端时延（ms） |
|:----:|:----------------:|:---------------:|
| 局域网  |       	122       |       	70       |
| 广域网  |       740        |       522       |

- 广域网测试时，机器人本体和服务器分别位于不同的地区，P2P模式下 端到端时延约为 522 ms。

<img src="./images/teleop-test-1.png" width=800 />

- 局域网测试时，机器人本体和服务器位于同一地区，P2P模式下端到端时延约为 70 ms。

<img src="./images/teleop-test-2.png" width=800 />


## 未来工作

为了提高WebRTC服务网关的性能和稳定性，我们需要对服务器进行一些优化措施，包括以下几个方面：

- 网络优化：我们需要选择合适的网络协议和传输方式，根据不同的场景选择UDP或TCP，以及使用SRTP或SRTCP等加密协议来保证数据安全。我们还需要利用STUN/TURN服务器来实现NAT穿越和数据中转，以及使用ICE框架来选择最佳的网络路径。
- CPU优化：我们需要合理地分配CPU资源，避免过多的线程切换和锁竞争。我们可以采用多线程优化方案，将I/O操作和业务逻辑处理分离到不同的线程中，并尽量让同一个房间的用户在同一个线程中处理。我们还可以利用Linux内核提供的Traffic Control框架，来模拟不同的网络环境，测试服务器在弱网情况下的表现。
- 内存优化：我们需要合理地管理内存资源，避免内存泄漏和碎片化。我们可以使用智能指针等技术来自动回收无用的内存空间，以及使用内存池等技术来减少内存分配和释放的开销。我们还可以利用Linux提供的huge page3功能，来减少TLB（Translation Lookaside Buffer）缺失导致的性能损失。
- 带宽优化：我们需要合理地利用带宽资源，避免带宽浪费和拥塞。我们可以根据不同用户的需求和网络状况，动态调整音视频流的码率、分辨率、帧率等参数。我们还可以使用SFU或MCU模型1，来实现多路音视频流的混合、转码、分发等功能，减少上行和下行带宽消耗。



[KubeEdge]: https://github.com/kubeedge/kubeedge
[edgemesh]: https://github.com/kubeedge/edgemesh